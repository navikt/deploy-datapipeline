apiVersion: bigquery.cnrm.cloud.google.com/v1beta1
kind: BigQueryDataset
metadata:
  annotations:
    cnrm.cloud.google.com/delete-contents-on-destroy: "false"
  name: deploys
  namespace: "nais-analyse"
  labels:
    "team": "nais-analyse"
spec:
  description: "Data about nais deploys"
  friendlyName: deploys
  location: europe-north1

---

apiVersion: bigquery.cnrm.cloud.google.com/v1beta1
kind: BigQueryTable
metadata:
  name: vera-deploys
  namespace: "nais-analyse"
  labels:
    "team": "nais-analyse"
spec:
  description: "Historical deploys from Vera"
  datasetRef:
    name: deploys
  friendlyName: vera-deploys
  schema: |
    [
      {
        "name": "environment",
        "type": "STRING"
      },
      {
        "name": "application",
        "type": "STRING"
      },
      {
        "name": "version",
        "type": "STRING"
      },
      {
        "name": "deployer",
        "type": "STRING"
      },
      {
        "name": "deployed_timestamp",
        "type": "TIMESTAMP"
      },
      {
        "name": "replaced_timestamp",
        "type": "TIMESTAMP"
      },
      {
        "name": "environmentClass",
        "type": "STRING"
      },
      {
        "name": "id",
        "type": "STRING"
      }
    ]

---

apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: deploy-datapipeline-bigquery-jobuser
  namespace: "nais-analyse"
  labels:
    "team": "nais-analyse"
spec:
  member: serviceAccount:deploy-data-nais-analy-5vtsumq@nais-prod-020f.iam.gserviceaccount.com
  role: roles/bigquery.jobUser
  resourceRef:
    apiVersion: bigquery.cnrm.cloud.google.com/v1beta1
    kind: BigQueryTable
    external: projects/nais-analyse-2dcc/datasets/deploys/tables/vera-deploys

---

apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPolicyMember
metadata:
  name: deploy-datapipeline-bigquery-dataviewer
  namespace: "nais-analyse"
  labels:
    "team": "nais-analyse"
spec:
  member: serviceAccount:deploy-data-nais-analy-5vtsumq@nais-prod-020f.iam.gserviceaccount.com
  role: roles/bigquery.dataViewer
  resourceRef:
    apiVersion: bigquery.cnrm.cloud.google.com/v1beta1
    kind: BigQueryTable
    external: projects/nais-analyse-2dcc/datasets/deploys/tables/vera-deploys