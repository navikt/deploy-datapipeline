name: Apply

on:
  push:
    branches:
      - "main"
    paths:
      - "bigquery/terraform**"

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: hashicorp/setup-terraform@v1.2.1
        with:
          terraform_version: 0.13.0

      - name: Terraform setup credentials
        id: credentials
        env:
          GCP_KEY: ${{ secrets.GCP_KEY }}
        run: echo $GCP_KEY > ${GITHUB_WORKSPACE}/sa.json

      - name: Set GOOGLE_CREDENTIALS
        id: google-cred
        run: echo "GOOGLE_CREDENTIALS=$(echo ${GITHUB_WORKSPACE}/sa.json)" >> $GITHUB_ENV

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: bigquery/terraform

      - name: Terraform Apply
        id: apply
        run: terraform apply -no-color -auto-approve -lock=false
        working-directory: bigquery/terraform